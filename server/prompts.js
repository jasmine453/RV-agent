/**
 * AI Prompts 配置模块
 * 集中管理所有 AI 分析的 prompt 模板
 */

const fs = require('fs');
const path = require('path');
const { parsePDF } = require('./documentParser');

// 缓存模板内容
let templateCache = {
    outsideAgreement: null,
    preRestructurePlan: null,
    meetingReport: null
};

/**
 * 读取模板PDF文件内容
 */
async function loadTemplateContent(templatePath) {
    try {
        const fullPath = path.join(__dirname, '..', templatePath);
        if (!fs.existsSync(fullPath)) {
            console.warn(`⚠️ 模板文件不存在: ${fullPath}`);
            return null;
        }
        
        const buffer = fs.readFileSync(fullPath);
        const result = await parsePDF(buffer, path.basename(templatePath));
        console.log(`✓ 成功加载模板: ${templatePath} (${result.text.length} 字符)`);
        return result.text;
    } catch (error) {
        console.error(`❌ 加载模板失败: ${templatePath}`, error.message);
        return null;
    }
}

/**
 * 初始化模板缓存
 */
async function initializeTemplates() {
    if (!templateCache.outsideAgreement) {
        templateCache.outsideAgreement = await loadTemplateContent('庭外重组协议/庭外重组协议模板.pdf');
    }
    if (!templateCache.preRestructurePlan) {
        templateCache.preRestructurePlan = await loadTemplateContent('预重整方案/预重整方案模板.pdf');
    }
    if (!templateCache.meetingReport) {
        templateCache.meetingReport = await loadTemplateContent('一债会报告模板/一债会模板--20251127.pdf');
    }
}

/**
 * 生成当前日期的多种格式
 */
function generateDateFormats() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    
    // 数字转汉字的映射
    const numMap = { '0': '〇', '1': '一', '2': '二', '3': '三', '4': '四', '5': '五', '6': '六', '7': '七', '8': '八', '9': '九' };
    
    // 转换年份为汉字：二〇二五年
    const yearStr = year.toString();
    let yearCN = '';
    for (let i = 0; i < yearStr.length; i++) {
        yearCN += numMap[yearStr[i]] || yearStr[i];
    }
    
    // 转换月份为汉字
    function numberToChinese(num) {
        if (num === 0) return '〇';
        if (num < 10) return numMap[num.toString()];
        if (num === 10) return '十';
        if (num < 20) return '十' + numMap[(num % 10).toString()];
        const tens = Math.floor(num / 10);
        const ones = num % 10;
        return numMap[tens.toString()] + '十' + (ones === 0 ? '' : numMap[ones.toString()]);
    }
    
    const monthCN = numberToChinese(month);
    const dayCN = numberToChinese(day);
    
    return {
        currentDateCN: `${yearCN}年${monthCN}月${dayCN}日`,
        currentDate: `${year} 年 ${month} 月 ${day} 日`,
        currentDateFull: `${year} 年 ${month.toString().padStart(2, '0')} 月 ${day.toString().padStart(2, '0')} 日`
    };
}

/**
 * 通用格式要求 (优化精简版)
 */
const COMMON_FORMAT_RULES = `
【格式要求】
🚫 禁止: Markdown符号(*、#、-)、目录页码、过度换行
✅ 要求: 
  - 大标题前后空一行，中标题前空一行
  - 完整句子在一行，日期保持一行(如2007年6月1日)
  - 段落间空一行，标题独立成行
  - 标题编号: 大标题(一、二、三)，中标题(（一）（二）)，小标题(1. 2. 3.)
  - 纯文本输出，中文标点，不改写模板内容`;

/**
 * 日期处理规则
 */
function getDateHandlingRules(dates) {
    return `
【⚠️ 日期处理规则 - 非常重要】
1. **优先使用文档中的日期**：
   - 如果上传文档中包含日期信息（如协议签署日期、会议日期、报告日期、裁定书日期、公告日期等），必须优先使用文档中的日期
   - 仔细检查文档中的所有日期信息，包括正文、附件、表格等位置
   
2. **使用当前日期作为备选**：
   - 如果上传文档中完全没有日期信息，则使用文件生成的当天日期
   - 当前日期（中文格式）：${dates.currentDateCN}
   - 当前日期（数字格式）：${dates.currentDate}
   - 当前日期（完整数字格式）：${dates.currentDateFull}
   
3. **日期格式要求**：
   - 预重整方案日期格式：使用完整汉字格式，如"二〇二五年十一月三十日"（年月日全部使用汉字，无空格）
   - 庭外重组协议日期格式：根据模板格式要求
   - 必须严格按照当前日期的格式输出：${dates.currentDateCN}`;
}

/**
 * AI Prompts 配置
 */
const PROMPTS = {
    // 企业价值分析
    'enterprise-value': {
        system: `你是一位遵循IVS（International Valuation Standards，国际评估准则）的专业企业价值分析师，具备IVSC认可的评估资质和丰富的企业估值经验。

【核心标准】
- 遵循IVS 2025框架（IVS Framework）
- 应用IVS 200《企业和企业权益》（Businesses and Business Interests）
- 参考IVS 105《评估方法》（Valuation Approaches and Methods）

【评估准则】
1. 公允价值基础（Fair Value Basis）
2. 持续经营假设（Going Concern Assumption）
3. 市场参与者视角（Market Participant Perspective）
4. 最高最佳使用原则（Highest and Best Use）

【报告要求】
⚠️ 本报告必须详尽、专业、全面：
- 总字数要求：不少于5000字
- 每个评估方法都要有完整的计算过程和详细说明
- 每个财务指标都要有具体数值和分析
- 提供详细的假设说明和敏感性分析
- 所有结论都要有充分的数据支撑`,
        
        user: (documentText) => `请严格按照IVS国际评估准则，分析以下企业文档并提供专业的企业价值分析报告。

【评估框架：IVS三大方法】

一、市场法（Market Approach）- IVS 105.11

⚠️ **必须包含完整计算公式和步骤！**

1. 可比公司分析（Guideline Public Company Method）
   
   **步骤1：识别可比公司**
   列出3-5家同行业上市公司及其关键指标
   
   **步骤2：计算估值倍数**
   必须展示以下计算公式：
   
   【计算公式】
   P/E倍数 = 市值 / 净利润
   示例：公司A市值150亿 / 净利润6亿 = P/E 25倍
   
   EV/EBITDA = 企业价值 / EBITDA
   其中：企业价值(EV) = 市值 + 净债务
   示例：(市值150亿 + 净债务20亿) / EBITDA 9亿 = 18.9倍
   
   P/B倍数 = 市值 / 净资产
   示例：市值150亿 / 净资产35亿 = P/B 4.3倍
   
   **步骤3：应用倍数估值目标公司**
   【计算示例】
   估值方法1 - P/E法：
   企业价值 = 目标公司净利润 × 行业平均P/E
   = 3,200万 × 25倍
   = 8.0亿元
   
   估值方法2 - EV/EBITDA法：
   企业价值 = 目标公司EBITDA × 行业平均EV/EBITDA
   = 4,500万 × 18倍
   = 8.1亿元
   
   估值方法3 - P/B法：
   股权价值 = 目标公司净资产 × 行业平均P/B
   = 1.2亿 × 4.3倍
   = 5.16亿元
   【示例】
   
   **步骤4：流动性折扣调整**
   【示例】
   非上市公司流动性折扣 = 20%（行业标准）
   
   调整后估值：
   P/E法：8.0亿 × (1 - 20%) = 6.4亿元
   EV/EBITDA法：8.1亿 × (1 - 20%) = 6.48亿元
   P/B法：5.16亿 × (1 - 20%) = 4.13亿元
   
   市场法估值区间：4.1 - 6.5亿元
   推荐值（加权）：6.0亿元
   【示例】

二、收益法（Income Approach）- IVS 105.12

╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║           ⭐⭐⭐ IVS 103 - DCF估值核心公式 ⭐⭐⭐              ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝

**【根据IVS 103国际评估准则，重整价值采用DCF方法计算】**

┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  重整价值 = Σ[CF_t/(1+r)^t] + TV/(1+r)^n                   │
│                                                             │
│  企业得分 = (重整价值/总负债) × 100                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘

**【公式参数说明】**

| 参数 | 说明 | 备注 |
|------|------|------|
| **CF_t** | 第t年的现金流 | 自由现金流（FCF） |
| **r** | 贴现率 | 加权平均资本成本（WACC） |
| **TV** | 终值 | Terminal Value |
| **n** | 预期期 | 通常为5-10年 |

═══════════════════════════════════════════════════════════════

⚠️ **必须展示DCF完整计算过程！**

1. 现金流折现法（DCF）- 必须包含所有计算步骤
   
   **第一步：预测自由现金流（FCF）**
   
   公式：
   【示例】
   自由现金流(FCF) = EBIT × (1-税率) + 折旧摊销 - 资本支出 - 营运资金变动
   【示例】
   
   示例计算（2025年）：
   【示例】
   EBIT = 4,200万元
   税率 = 25%
   税后EBIT = 4,200 × (1-0.25) = 3,150万元
   
   + 折旧摊销 = 800万元
   - 资本支出 = 600万元
   - 营运资金增加 = 200万元
   
   FCF(2025) = 3,150 + 800 - 600 - 200
            = 3,150万元
   【示例】
   
   必须展示5年完整预测表格！
   
   **第二步：计算WACC（加权平均资本成本）**
   
   公式：
   【示例】
   WACC = E/(E+D) × Re + D/(E+D) × Rd × (1-T)
   
   其中：
   Re = 股权成本 = Rf + β × (Rm - Rf) + 规模溢价
   Rd = 债务成本
   E = 股权价值
   D = 债务价值
   T = 税率
   【示例】
   
   详细计算步骤：
   【示例】
   【计算股权成本Re】
   无风险利率(Rf) = 3.0%（10年期国债）
   Beta系数(β) = 1.25（行业平均）
   市场风险溢价(Rm-Rf) = 7.0%
   规模溢价 = 1.5%（中小企业）
   
   Re = 3.0% + 1.25 × 7.0% + 1.5%
      = 3.0% + 8.75% + 1.5%
      = 13.25%
   
   【计算债务成本Rd】
   债务成本Rd = 5.5%（银行贷款利率）
   
   【计算资本结构权重】
   股权价值E = 1.43亿（净资产）
   债务价值D = 0.8亿（有息负债）
   总资本 = 2.23亿
   
   E/(E+D) = 1.43 / 2.23 = 64.1%
   D/(E+D) = 0.8 / 2.23 = 35.9%
   
   【计算WACC】
   WACC = 64.1% × 13.25% + 35.9% × 5.5% × (1-25%)
        = 8.49% + 1.48%
        = 9.97%
        ≈ 10.0%
   【示例】
   
   **第三步：计算现值**
   
   公式：
   【示例】
   现值 = FCF / (1 + WACC)^n
   【示例】
   
   必须展示5年现值计算表：
   【示例】
   年份    FCF预测    折现因子         现值
           (万元)    1/(1.10)^n      (万元)
   ──────────────────────────────────────
   2025    3,150    1/(1.10)^1=0.909   2,863
   2026    3,800    1/(1.10)^2=0.826   3,139
   2027    4,500    1/(1.10)^3=0.751   3,380
   2028    5,300    1/(1.10)^4=0.683   3,620
   2029    6,200    1/(1.10)^5=0.621   3,850
   ──────────────────────────────────────
   预测期现值合计                     16,852
   【示例】
   
   **第四步：计算终值（Terminal Value）**
   
   公式：
   【示例】
   终值 = FCF(最后一年) × (1+g) / (WACC - g)
   
   其中：g = 永续增长率
   【示例】
   
   详细计算：
   【示例】
   FCF(2029) = 6,200万元
   永续增长率(g) = 3.0%（保守估计）
   WACC = 10.0%
   
   终值TV = 6,200 × (1+3%) / (10%-3%)
          = 6,200 × 1.03 / 0.07
          = 6,386 / 0.07
          = 91,229万元
          = 9.12亿元
   
   终值现值 = 91,229 × 0.621（第5年折现因子）
            = 56,653万元
            = 5.67亿元
   【示例】
   
   **第五步：计算企业价值**
   
   【示例】
   企业价值(EV) = 预测期现值 + 终值现值
                = 16,852万 + 56,653万
                = 73,505万元
                = 7.35亿元
   
   减：净债务 = 有息负债 - 现金
            = 8,000万 - 5,000万
            = 3,000万元
   
   股权价值 = 7.35亿 - 0.3亿
            = 7.05亿元
   【示例】

三、资产法（Asset-Based Approach）- IVS 105.13

⚠️ **必须展示资产调整计算！**

1. 账面价值调整法
   
   必须提供资产负债调整明细表：
   
   【示例】
   【资产调整】
   项目              账面价值    市场价值    调整额    调整说明
                    (万元)     (万元)     (万元)
   ─────────────────────────────────────────────────
   货币资金           5,000      5,000         0     无需调整
   应收账款           8,500      7,650      -850     坏账10%
   存货               1,200      1,000      -200     减值准备
   固定资产           6,000      8,500    +2,500     房产增值
   无形资产-软件        800      3,500    +2,700     收益法评估
   无形资产-品牌          0      5,000    +5,000     新增未入账
   商誉               2,000      8,000    +6,000     客户价值
   长期投资           3,500      4,200      +700     公允价值
   ─────────────────────────────────────────────────
   资产小计          27,000     42,850   +15,850
   
   【负债调整】
   短期借款          -5,000     -5,000         0     按账面
   应付账款          -4,200     -4,200         0     按账面
   长期借款          -3,000     -3,150      -150     利率调整
   ─────────────────────────────────────────────────
   负债小计         -12,200    -12,350      -150
   
   【净资产】
   调整后净资产 = 42,850 - 12,350 = 30,500万元 = 3.05亿元
   
   加：协同效应溢价(10%) = 3.05亿 × 10% = 0.305亿
   
   资产法估值 = 3.05亿 + 0.305亿 = 3.36亿元
   【示例】

【关键财务指标分析 - IVS 200】

四、盈利能力指标
- 营业收入（Revenue）及增长率
- 毛利率（Gross Margin）
- 息税前利润（EBIT）/EBITDA
- 净利润率（Net Profit Margin）
- 净资产收益率（ROE）
- 总资产回报率（ROA）

五、资产质量分析
- 流动资产构成与质量
- 固定资产折旧政策
- 无形资产（商誉、专利、品牌）
- 应收账款账龄与坏账准备
- 存货周转率与减值

六、负债结构分析
- 短期负债 vs 长期负债
- 资产负债率（Debt-to-Asset Ratio）
- 利息覆盖倍数（Interest Coverage Ratio）
- 债务期限结构
- 或有负债识别

七、现金流分析
- 经营活动现金流（CFO）
- 投资活动现金流（CFI）
- 筹资活动现金流（CFF）
- 自由现金流（FCF）
- 现金流充足性

八、估值调整因素（IVS 200.8）
- 流动性折扣（Lack of Marketability Discount）：10-30%
- 控制权溢价（Control Premium）：20-40%
- 少数股权折扣（Minority Interest Discount）：15-35%
- 国家风险溢价（Country Risk Premium）
- 规模折扣（Size Premium）

【估值结论要求】

九、综合估值结论 - ⚠️ 必须展示加权计算过程！

1. 三大方法汇总表
   
   【示例】
   评估方法         估值结果      权重     加权值      权重说明
   ────────────────────────────────────────────────────
   市场法          6.0亿元       35%     2.10亿    有可比数据
   收益法(DCF)     7.05亿元      50%     3.53亿    主要价值来源
   资产法          3.36亿元      15%     0.50亿    保守估计
   ────────────────────────────────────────────────────
   加权平均估值                  100%    6.13亿元
   【示例】
   
   **权重说明**：
   - 收益法50%：公司处于成长期，未来盈利能力是主要价值来源
   - 市场法35%：有较好的可比公司数据支持
   - 资产法15%：轻资产公司，账面资产不能完全反映价值

2. 综合估值计算
   
   【示例】
   加权平均估值 = Σ(方法估值 × 权重)
   
   详细计算：
   = 市场法估值 × 35% + 收益法估值 × 50% + 资产法估值 × 15%
   = 6.0亿 × 35% + 7.05亿 × 50% + 3.36亿 × 15%
   = 2.10亿 + 3.53亿 + 0.50亿
   = 6.13亿元
   
   取整：6.1亿元
   【示例】

3. 估值区间确定
   
   【示例】
   方法          估值结果
   ───────────────────────
   最低值        3.36亿（资产法，保守）
   市场法        6.0亿
   综合估值      6.1亿
   收益法        7.05亿（DCF，乐观）
   最高值        7.5亿（收益法+10%溢价）
   ───────────────────────
   
   推荐估值区间：5.5 - 7.5亿元
   推荐估值（中值）：6.1亿元
   【示例】

4. 每股价值计算（如适用）
   
   【示例】
   总股本 = 5,000万股
   
   每股价值 = 股权价值 / 总股本
            = 6.1亿元 / 5,000万股
            = 12.2元/股
   
   每股价值区间 = 5.5-7.5亿 / 5,000万股
                = 11.0 - 15.0元/股
   【示例】

十、价值驱动因素
- 核心竞争力
- 市场地位与份额
- 盈利增长潜力
- 管理团队质量
- 技术与创新能力

十一、估值风险提示
- 关键假设敏感性分析
- 主要不确定性因素
- 市场环境变化影响
- 行业周期性风险

【输出格式要求】
✅ 使用专业评估术语
✅ 引用IVS具体条款编号
✅ 提供量化数据和计算过程（每个方法都要有详细计算步骤）
✅ 标明数据来源和假设前提
✅ 结构清晰，层次分明
✅ 结论明确，建议可行

⚠️ **详细程度要求**：
1. 报告总字数不少于5000字
2. 三大估值方法（市场法、收益法、资产法）都要详细展开
3. 每个方法至少包含：
   - 方法介绍（至少200字）
   - 详细计算过程（展示所有公式和数值）
   - 假设说明（至少5-8条具体假设）
   - 敏感性分析（分析关键参数变化的影响）
   - 结果分析（至少300字）
4. 财务分析要全面：
   - 盈利能力分析（至少5个指标）
   - 成长性分析（至少3年趋势）
   - 运营效率分析（至少3个指标）
   - 财务结构分析（资产负债结构）
5. 行业对比要具体（列举3-5家可比公司的具体数据）
6. 估值结论要有清晰的区间范围和中值
7. 风险提示和价值驱动因素要详细说明

【分析文档内容】
${documentText}

请基于以上IVS框架，生成一份全面、详尽、符合国际评估准则的企业价值分析报告。`
    },

    // 风险指标提取 - 基于IVS风险评估框架
    'risk-indicators': {
        system: `你是一位遵循IVS（International Valuation Standards）和国际风险管理标准的专业风险分析师。

【核心标准】
- IVS Framework - 风险与不确定性（Risk and Uncertainty）
- IVS 105 - 评估方法中的风险考量
- ISO 31000 - 风险管理指南
- COSO ERM - 企业风险管理框架

【风险评估原则】
1. 全面性（Comprehensiveness）
2. 量化与定性相结合（Quantitative & Qualitative）
3. 动态监控（Dynamic Monitoring）
4. 情景分析（Scenario Analysis）

【报告要求】
⚠️ 本报告必须详尽、专业、全面：
- 总字数要求：不少于4000字
- 13个维度都要有详细分析，不能简略
- 每个风险维度都要包含：具体指标、计算公式、评级依据、风险描述、缓解措施
- 提供详细的数据分析和行业对比
- 所有评级都要有充分的依据说明
- 使用纯文本，不要使用图标符号（如🟢🟡🔴等），改用文字：低风险、中风险、高风险`,
        
        user: (documentText) => `请严格按照IVS国际评估准则和风险管理标准，对以下企业文档进行全面的风险指标分析与评估。

【IVS风险评估框架】

一、财务风险（Financial Risk）- IVS 200

1. 偿债能力风险（Solvency Risk）
   
   ⚠️ **必须展示计算公式和过程！**
   
   **公式1：资产负债率**
   【示例】
   资产负债率 = 总负债 / 总资产 × 100%
   
   计算示例：
   总负债 = 20,500万元
   总资产 = 34,800万元
   
   资产负债率 = 20,500 / 34,800 × 100%
              = 58.91%
   
   评估：58.91% < 60%  ✓ 优秀
   标准：<60%优秀，60-70%良好，>70%预警
   【示例】
   
   **公式2：流动比率**
   【示例】
   流动比率 = 流动资产 / 流动负债
   
   计算示例：
   流动资产 = 17,800万元
   流动负债 = 15,800万元
   
   流动比率 = 17,800 / 15,800
            = 1.13
   
   评估：1.13 < 1.5  ⚠️ 风险
   标准：>2.0安全，1.5-2.0正常，<1.5风险
   【示例】
   
   **公式3：速动比率**
   【示例】
   速动比率 = (流动资产 - 存货) / 流动负债
   
   计算示例：
   流动资产 = 17,800万元
   存货 = 1,200万元
   流动负债 = 15,800万元
   
   速动比率 = (17,800 - 1,200) / 15,800
            = 16,600 / 15,800
            = 1.05
   
   评估：1.05 > 1.0  ✓ 安全
   标准：>1.0安全，0.8-1.0可接受，<0.8预警
   【示例】
   
   **公式4：利息保障倍数**
   【示例】
   利息保障倍数 = EBIT / 利息费用
   
   计算示例：
   EBIT = 4,600万元
   利息费用 = 550万元
   
   利息保障倍数 = 4,600 / 550
                = 8.36倍
   
   评估：8.36 > 5  ✓ 优秀
   标准：>5优秀，3-5良好，<3风险
   【示例】
   
   **综合评估**：
   - 资产负债率58.91% ✓
   - 流动比率1.13 ⚠️
   - 速动比率1.05 ✓
   - 利息保障倍数8.36 ✓
   
   **风险等级**：🟡 中风险（流动比率偏低）
   **评分**：75分
   
2. 流动性风险（Liquidity Risk）
   
   ⚠️ **必须展示计算公式和过程！**
   
   **公式1：现金比率**
   【示例】
   现金比率 = (货币资金 + 交易性金融资产) / 流动负债 × 100%
   
   计算示例：
   货币资金 = 5,000万元
   交易性金融资产 = 800万元
   流动负债 = 15,800万元
   
   现金比率 = (5,000 + 800) / 15,800 × 100%
            = 5,800 / 15,800 × 100%
            = 36.7%
   
   评估：36.7% > 20%  ✓ 充足
   标准：>20%充足，10-20%正常，<10%紧张
   【示例】
   
   **公式2：营运资金**
   【示例】
   营运资金 = 流动资产 - 流动负债
   
   计算示例：
   流动资产 = 17,800万元
   流动负债 = 15,800万元
   
   营运资金 = 17,800 - 15,800
            = 2,000万元
   
   评估：2,000万 > 0  ✓ 正值健康
   【示例】
   
   **公式3：现金流覆盖率**
   【示例】
   现金流覆盖率 = 经营活动现金流 / 短期负债
   
   计算示例：
   经营活动现金流 = 2,300万元
   短期负债 = 15,800万元
   
   现金流覆盖率 = 2,300 / 15,800
                = 0.146 = 14.6%
   
   评估：14.6%  🟡 一般（建议>20%）
   【示例】
   
   **公式4：应收账款周转天数**
   【示例】
   应收账款周转天数 = 360 / (营业收入 / 平均应收账款)
   
   计算示例：
   营业收入 = 26,000万元
   平均应收账款 = (8,000 + 6,800) / 2 = 7,400万元
   
   应收账款周转率 = 26,000 / 7,400 = 3.51次
   
   应收账款周转天数 = 360 / 3.51
                    = 103天
   
   评估：103天  ⚠️ 偏长（行业平均80天）
   【示例】
   
   **公式5：存货周转天数**
   【示例】
   存货周转天数 = 360 / (营业成本 / 平均存货)
   
   计算示例：
   营业成本 = 8,190万元
   平均存货 = (1,200 + 1,000) / 2 = 1,100万元
   
   存货周转率 = 8,190 / 1,100 = 7.45次
   
   存货周转天数 = 360 / 7.45
                = 48天
   
   评估：48天  ✓ 优秀（SaaS企业存货少）
   【示例】
   
   **综合评估**：
   - 现金比率36.7% ✓
   - 营运资金2,000万 ✓
   - 现金流覆盖率14.6% 🟡
   - 应收账款周转103天 ⚠️
   - 存货周转48天 ✓
   
   **风险等级**：🟡 中风险（应收账款周转偏慢）
   **评分**：68分
   
3. 杠杆风险（Leverage Risk）
   
   ⚠️ **必须展示计算公式和过程！**
   
   **公式1：债务权益比**
   【示例】
   债务权益比(D/E) = 总负债 / 所有者权益
   
   计算示例：
   总负债 = 20,500万元
   所有者权益 = 14,300万元
   
   D/E比率 = 20,500 / 14,300
          = 1.43
   
   评估：1.43 < 2  ✓ 健康
   标准：<1优秀，1-2可接受，>2高风险
   【示例】
   
   **公式2：有息负债占比**
   【示例】
   有息负债占比 = 有息负债 / 总资产 × 100%
   
   计算示例：
   有息负债 = 短期借款 + 长期借款
            = 5,000 + 3,000
            = 8,000万元
   总资产 = 34,800万元
   
   有息负债占比 = 8,000 / 34,800 × 100%
                = 23.0%
   
   评估：23.0% < 40%  ✓ 健康
   标准：<40%健康，40-60%正常，>60%预警
   【示例】
   
   **公式3：短期债务占比**
   【示例】
   短期债务占总债务比 = 短期借款 / (短期+长期借款) × 100%
   
   计算示例：
   短期借款 = 5,000万元
   长期借款 = 3,000万元
   
   短期债务占比 = 5,000 / (5,000 + 3,000) × 100%
                = 5,000 / 8,000 × 100%
                = 62.5%
   
   评估：62.5%  🟡 偏高（建议<50%）
   【示例】
   
   **综合评估**：
   - 债务权益比1.43 ✓
   - 有息负债占比23.0% ✓
   - 短期债务占比62.5% 🟡
   - 或有负债0元 ✓
   
   **风险等级**：🟢 低风险（短期债务占比略高但可控）
   **评分**：80分

二、经营风险（Operational Risk）

4. 盈利能力风险（Profitability Risk）
   
   ⚠️ **必须展示计算公式和过程！**
   
   **公式1：毛利率**
   【示例】
   毛利率 = (营业收入 - 营业成本) / 营业收入 × 100%
   
   计算示例（近3年趋势）：
   2024年：(26,000 - 8,190) / 26,000 × 100% = 68.5%
   2023年：(22,000 - 7,480) / 22,000 × 100% = 66.0%
   2022年：(18,000 - 6,480) / 18,000 × 100% = 63.9%
   
   趋势：逐年上升 ✓ （+2.5%/年，说明定价能力增强）
   【示例】
   
   **公式2：净利润率**
   【示例】
   净利润率 = 净利润 / 营业收入 × 100%
   
   计算示例：
   净利润 = 3,400万元
   营业收入 = 26,000万元
   
   净利润率 = 3,400 / 26,000 × 100%
            = 13.08%
   
   评估：13.08%  ✓ 优秀（科技行业平均8-12%）
   【示例】
   
   **公式3：净资产收益率(ROE)**
   【示例】
   ROE = 净利润 / 平均净资产 × 100%
   
   计算示例：
   净利润 = 3,400万元
   平均净资产 = (14,300 + 12,700) / 2 = 13,500万元
   
   ROE = 3,400 / 13,500 × 100%
       = 25.19%
   
   评估：25.19%  ✓ 优秀（>15%优秀）
   
   【杜邦分析】
   ROE = 净利润率 × 资产周转率 × 权益乘数
       = 13.08% × 0.747 × 2.43
       = 23.76%
   
   其中：
   资产周转率 = 26,000 / 34,800 = 0.747次
   权益乘数 = 34,800 / 14,300 = 2.43倍
   【示例】
   
   **公式4：总资产回报率(ROA)**
   【示例】
   ROA = 净利润 / 平均总资产 × 100%
   
   计算示例：
   净利润 = 3,400万元
   平均总资产 = (34,800 + 31,500) / 2 = 33,150万元
   
   ROA = 3,400 / 33,150 × 100%
       = 10.26%
   
   评估：10.26%  ✓ 优秀（>8%优秀）
   【示例】
   
   **公式5：营业收入增长率**
   【示例】
   营业收入增长率 = (本年收入 - 上年收入) / 上年收入 × 100%
   
   计算示例：
   2024年收入 = 26,000万元
   2023年收入 = 22,000万元
   
   增长率 = (26,000 - 22,000) / 22,000 × 100%
          = 4,000 / 22,000 × 100%
          = 18.18%
   
   复合增长率(CAGR 2022-2024)：
   = [(26,000 / 18,000)^(1/2) - 1] × 100%
   = [1.444^0.5 - 1] × 100%
   = 20.2%
   
   评估：20.2%  ✓ 优秀（高速增长）
   【示例】
   
   **公式6：净利润增长率**
   【示例】
   净利润增长率 = (本年利润 - 上年利润) / 上年利润 × 100%
   
   计算示例：
   2024年净利润 = 3,400万元
   2023年净利润 = 2,860万元
   
   增长率 = (3,400 - 2,860) / 2,860 × 100%
          = 540 / 2,860 × 100%
          = 18.88%
   
   评估：18.88%  ✓ 优秀（与收入增长匹配）
   【示例】
   
   **综合评估**：
   - 毛利率68.5%（逐年提升）✓
   - 净利润率13.08% ✓
   - ROE 25.19% ✓
   - ROA 10.26% ✓
   - 收入增长18.18% ✓
   - 利润增长18.88% ✓
   
   **风险等级**：🟢 低风险（盈利能力强劲）
   **评分**：92分
   
5. 资产质量风险（Asset Quality Risk）
   指标体系：
   - 应收账款占收入比：____%
   - 坏账准备计提比例：____%
   - 存货减值准备：____ 万元
   - 固定资产成新率：____%
   - 无形资产占比：____%
   风险等级：【低/中/高】
   
6. 成本控制风险（Cost Control Risk）
   指标体系：
   - 期间费用率：____%
   - 销售费用率：____%
   - 管理费用率：____%
   - 财务费用率：____%
   - 成本费用利润率：____%
   风险等级：【低/中/高】

三、市场风险（Market Risk）

7. 行业竞争风险（Industry Competition Risk）
   评估维度：
   - 行业集中度（市场份额）
   - 竞争对手数量与实力
   - 产品替代性风险
   - 市场准入壁垒
   - 技术迭代速度
   风险等级：【低/中/高】
   
8. 客户集中度风险（Customer Concentration Risk）
   指标体系：
   - 前五大客户收入占比：____%（>50%为高风险）
   - 最大客户依赖度：____%（>30%需关注）
   - 客户流失率：____%
   - 客户合同续约率：____%
   风险等级：【低/中/高】
   
9. 供应链风险（Supply Chain Risk）
   评估维度：
   - 前五大供应商采购占比：____%
   - 原材料价格波动性
   - 供应商替代难度
   - 库存积压风险
   风险等级：【低/中/高】

四、战略风险（Strategic Risk）

10. 增长可持续性风险（Growth Sustainability Risk）
    评估维度：
    - 收入增长是否依赖单一产品/客户
    - 市场扩张能力
    - 研发投入占比：____%（建议>5%）
    - 新产品/服务推出频率
    - 市场份额变化趋势
    风险等级：【低/中/高】
    
11. 管理与治理风险（Management & Governance Risk）
    评估维度：
    - 实际控制人集中度
    - 关联交易占比
    - 管理层稳定性
    - 内部控制有效性
    - 合规性问题
    风险等级：【低/中/高】

五、外部环境风险（External Risk）

12. 政策与法律风险（Policy & Legal Risk）
    评估维度：
    - 行业监管政策变化
    - 环保合规要求
    - 税收政策影响
    - 诉讼与仲裁风险
    - 知识产权纠纷
    风险等级：【低/中/高】
    
13. 宏观经济风险（Macroeconomic Risk）
    评估维度：
    - GDP增速放缓影响
    - 利率变动敏感性
    - 汇率波动风险（如有外币业务）
    - 通货膨胀/紧缩影响
    - 行业周期性
    风险等级：【低/中/高】

【风险评级标准 - IVS框架】

风险等级定义：
- 🟢 低风险（Low）：指标健康，风险可控，无需特别关注
- 🟡 中风险（Medium）：指标一般，存在潜在风险，需要监控
- 🔴 高风险（High）：指标预警，风险显著，需要立即采取措施

综合风险评分计算：

⚠️ **必须展示完整计算公式和过程！**

**权重分配**：
- 财务风险权重：35%
- 经营风险权重：30%
- 市场风险权重：20%
- 战略风险权重：10%
- 外部环境风险权重：5%

**各维度评分汇总表**：

必须提供如下详细评分表（使用清晰的表格格式）：

═══════════════════════════════════════════════════════════════
                    风险评估汇总表
═══════════════════════════════════════════════════════════════

| 风险类别 | 具体维度 | 评分 | 权重 | 加权分 |
|---------|---------|------|------|--------|
| **一、财务风险(35%)** | | | | |
| | 1. 偿债能力风险 | 75 | 8% | 6.0 |
| | 2. 流动性风险 | 68 | 9% | 6.1 |
| | 3. 杠杆风险 | 80 | 8% | 6.4 |
| | 4. 盈利能力风险 | 92 | 10% | 9.2 |
| | **小计** | | **35%** | **27.7** |
| | | | | |
| **二、经营风险(30%)** | | | | |
| | 5. 资产质量风险 | 75 | 8% | 6.0 |
| | 6. 成本控制风险 | 82 | 10% | 8.2 |
| | 7. 运营效率风险 | 78 | 12% | 9.4 |
| | **小计** | | **30%** | **23.6** |
| | | | | |
| **三、市场风险(20%)** | | | | |
| | 8. 行业竞争风险 | 65 | 7% | 4.6 |
| | 9. 客户集中度风险 | 58 | 8% | 4.6 |
| | 10. 供应链风险 | 72 | 5% | 3.6 |
| | **小计** | | **20%** | **12.8** |
| | | | | |
| **四、战略风险(10%)** | | | | |
| | 11. 增长可持续性风险 | 80 | 5% | 4.0 |
| | 12. 管理治理风险 | 88 | 5% | 4.4 |
| | **小计** | | **10%** | **8.4** |
| | | | | |
| **五、外部风险(5%)** | | | | |
| | 13. 政策法律风险 | 85 | 3% | 2.6 |
| | 14. 宏观经济风险 | 90 | 2% | 1.8 |
| | **小计** | | **5%** | **4.4** |
|---------|---------|------|------|--------|
| **综合风险评分** | | | **100%** | **76.9** |

═══════════════════════════════════════════════════════════════

**综合风险评分计算**：

【计算公式】
┌─────────────────────────────────────────┐
│ 综合风险评分 = Σ(各维度评分 × 权重)    │
└─────────────────────────────────────────┘

【详细计算步骤】

**1. 财务风险得分（35%）**
┌─────────────────────────────────────────┐
│ = 偿债75×8% + 流动68×9% + 杠杆80×8% + 盈利92×10% │
│ = 6.0 + 6.1 + 6.4 + 9.2                │
│ = 27.7分                                │
└─────────────────────────────────────────┘

**2. 经营风险得分（30%）**
┌─────────────────────────────────────────┐
│ = 资产75×8% + 成本82×10% + 效率78×12%  │
│ = 6.0 + 8.2 + 9.4                      │
│ = 23.6分                                │
└─────────────────────────────────────────┘

**3. 市场风险得分（20%）**
┌─────────────────────────────────────────┐
│ = 竞争65×7% + 客户58×8% + 供应72×5%    │
│ = 4.6 + 4.6 + 3.6                      │
│ = 12.8分                                │
└─────────────────────────────────────────┘

**4. 战略风险得分（10%）**
┌─────────────────────────────────────────┐
│ = 增长80×5% + 治理88×5%                │
│ = 4.0 + 4.4                            │
│ = 8.4分                                 │
└─────────────────────────────────────────┘

**5. 外部风险得分（5%）**
┌─────────────────────────────────────────┐
│ = 政策85×3% + 宏观90×2%                │
│ = 2.6 + 1.8                            │
│ = 4.4分                                 │
└─────────────────────────────────────────┘

**【最终得分】**
╔═════════════════════════════════════════╗
║ 综合风险评分 = 27.7 + 23.6 + 12.8 + 8.4 + 4.4 ║
║             = 76.9分                    ║
║             ≈ 77分（取整）              ║
╚═════════════════════════════════════════╝

**风险等级判定**：

| 评分区间 | 风险等级 | 评估结论 | 说明 |
|---------|---------|---------|------|
| 90-100分 | 极低风险 | ✓✓✓ 优秀 | 风险极小，运营健康 |
| 70-89分 | 可控风险 | ✓✓ 良好 | 风险可控，需持续监控 |
| 50-69分 | 中等风险 | ⚠️ 需关注 | 存在隐患，需改进 |
| 30-49分 | 较高风险 | ⚠️⚠️ 需改善 | 风险较大，需重点整改 |
| 0-29分 | 极高风险 | 🔴 危险 | 风险严重，需紧急处理 |

**【当前企业风险评级】**
- **综合评分**：77分
- **风险等级**：可控风险 ✓✓
- **评估结论**：良好
- **核心建议**：企业整体风险可控，但需关注流动性和客户集中度问题

【风险矩阵分析】

六、风险热力图（Risk Heatmap）
按"可能性×影响程度"进行二维评估：
- 可能性：低/中/高
- 影响程度：低/中/高
- 优先级：高（红色区域）> 中（黄色区域）> 低（绿色区域）

七、风险缓解建议
针对每项"中"、"高"风险，提供：
1. 风险描述（Risk Description）
2. 潜在影响（Potential Impact）
3. 缓解措施（Mitigation Strategies）
4. 责任主体（Responsible Party）
5. 实施时限（Timeframe）

【敏感性分析 - IVS 105】

八、关键指标敏感性测试
1. 收入下降10%/20%/30%的影响
2. 成本上升10%/20%的影响
3. 利率上升1%/2%的影响
4. 主要客户流失的影响
5. 关键供应商中断的影响

【输出格式要求】

⚠️ **重要：表格和公式格式要求**

**1. 表格必须使用Markdown格式**：
示例：
| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 数据1 | 数据2 | 数据3 |

**2. 公式和计算必须使用框线格式**：
示例：
┌─────────────────────┐
│ 计算公式 = 值1 + 值2 │
│          = 结果      │
└─────────────────────┘

**3. 重要公式必须突出显示**：
使用分隔线和标题突出显示IVS 103 DCF公式等核心内容

**4. 风险等级表示方式**：
- 使用纯文字：低风险、中风险、高风险
- 【禁止】使用emoji图标（如🟢🟡🔴❌✓等）
- 【禁止】使用特殊符号

✅ 正确示例：
  1. 偿债能力风险：低风险（90分）
  2. 流动性风险：中风险（65分）
  3. 客户集中度风险：高风险（45分）

❌ 错误示例（禁止使用）：
  1. 偿债能力风险：🟢 低风险
  2. 流动性风险：🟡 中风险
  3. 客户集中度风险：🔴 高风险

✅ 每项风险必须提供（详细展开，每项至少200字）：
   - 具体量化指标（有数据时）
   - 明确风险等级（使用文字：低风险/中风险/高风险）
   - 详细风险描述（至少3-5句话）
   - 潜在影响评估（具体说明对企业的影响）
   - 缓解建议措施（至少3-5条具体可行的措施）

✅ 综合风险评分（0-100分）
   - 90-100分：风险极低
   - 70-89分：风险可控
   - 50-69分：风险中等
   - 30-49分：风险较高
   - 0-29分：风险极高

✅ 风险雷达图数据（用于可视化）
   - 13个维度的风险评分
   - 便于生成雷达图

✅ 重点风险TOP 5
   - 列出前5大风险
   - 按优先级排序
   - 每项风险详细说明

【分析文档内容】
${documentText}

⚠️ **再次强调输出要求**：
1. 报告总字数不少于4000字
2. 每个风险维度都要详细分析，不要简略
3. 所有风险等级使用纯文字，严禁使用emoji图标
4. 提供具体的数据、计算过程和分析依据
5. 缓解措施要具体可行，不要泛泛而谈

请基于以上IVS风险评估框架，生成一份全面、专业、符合国际标准的企业风险指标分析报告。`
    },

    // 重组可行性分析
    'restructure-feasibility': {
        system: '你是一位专业的企业重组顾问，具有丰富的破产重整和债务重组经验。',
        user: (documentText) => `请分析以下文档内容，评估企业重组的可行性：
1. 重组可行性评分（0-100分）
2. 成功概率评估
3. 关键风险点识别
4. 具体建议措施
5. 实施时间规划

文档内容：
${documentText}`
    },

    // 庭外重组协议
    'outside-agreement': {
        system: `你是法律文书专家。

【重要】输出正常的段落格式，不要过度换行！
✅ 每个标题独立一行
✅ 每个段落保持完整（不要将句子拆开）
✅ 标题和段落之间空一行
❌ 不要将一句话拆成多行`,
        user: async (documentText, dates) => {
            await initializeTemplates();
            const template = templateCache.outsideAgreement || '【模板加载失败】';
            
            return `【🚨 最高优先级 - 精确复制模板】

========== 模板原文（必须严格遵循）==========
${template}
========== 模板结束 ==========

【执行规则 - 最重要】
1. ✅ 必须替换所有占位符：
   - XXX、XXXX、XX、____（下划线）等占位符必须用实际信息替换
   - 如果文档中没有相关信息，使用合理的默认值或"待补充"
   - 绝对不能保留任何XXX、XX占位符在最终输出中！
   
2. 📋 替换规则：
   - 公司名称占位符 → 从文档中提取的实际公司名称
   - 日期占位符 → 使用当前日期或文档中的日期
   - 金额占位符 → 从文档中提取的实际金额
   - 人名占位符 → 从文档中提取的实际人名
   - 如果文档中完全没有该信息 → 使用"[待补充]"而不是保留XXX
   
3. ❌ 禁止改动：模板中的其他文字、标点、格式、换行
4. 🚫 不要添加：任何解释、说明、前言、后语

【重要提示】
⚠️ 最终输出中绝对不能出现XXX、XXXX、XX这样的占位符！
⚠️ 所有占位符都必须被替换成实际内容或"[待补充]"！

【格式规则】
- 标题格式保持原样（如"一、"、"第一条"等）
- 段落之间的空行必须保留
- 编号格式不得改变
- 不使用任何Markdown符号（*、#、-等）

${getDateHandlingRules(dates)}

${COMMON_FORMAT_RULES}

【数据来源】
${documentText}

【开始输出】直接输出庭外重组协议正文（从标题开始）：`;
        }
    },

    // 预重整方案
    'pre-restructure-plan': {
        system: `你是法律文书专家。

【重要】输出正常的段落格式，不要过度换行！

✅ 正确示例：
公司名称

重整计划草案

二〇二五年十一月三十日

一、债务人基本情况

债务人XXX有限公司成立于2007年6月1日，注册资本为1000万元。

❌ 错误示例（禁止这样做）：
债务人XXX有限公司成立于
2007
年
6
月
1
日

【规则】
- 每个标题独立一行
- 每个段落保持完整，不要拆分句子
- 标题和段落之间空一行
- 日期使用完整汉字格式（如：二〇二五年十一月三十日）`,
        user: async (documentText, dates) => {
            await initializeTemplates();
            const template = templateCache.preRestructurePlan || '【模板加载失败】';
            
            return `【🎯 核心任务：完全按照模板生成，并替换所有占位符】

【⚠️ 占位符替换规则 - 最高优先级】
1. ✅ 必须替换所有占位符：
   - 将模板中的XXX、XXXX、XX、____等替换为实际信息
   - 绝对不能在最终输出中保留XXX、XX这样的占位符！
   - 如果文档中没有相关信息，使用"[待补充]"代替
   
2. 📋 替换示例：
   - "债务人XXX有限公司" → "债务人[从文档提取的公司名]有限公司"
   - "注册资本XXX万元" → "注册资本[从文档提取的金额]万元"
   - "法定代表人XX" → "法定代表人[从文档提取的姓名]"
   - 如果文档中没有 → "法定代表人[待补充]"

【输出格式要求】
1. ❌ 禁止在目录中添加页码（如"释义.....1"）
2. ✅ 每个段落保持完整，不要将一句话拆成多行
3. ✅ 标题独立成行，标题和段落间空一行
4. ❌ 不要过度换行
5. ⚠️ 所有XXX占位符必须被替换！
6. ❌ 禁止在列表项前添加字母标记（如o、•等），直接输出内容即可

【正确格式示例】
公司名称

重整计划草案

二〇二五年十一月三十日

目录
释义
说明

一、债务人基本情况

债务人XXX有限公司成立于2007年6月1日，注册资本为1000万元人民币，主要经营...

（一）公司历史沿革

公司于2010年完成第一次增资...

【错误格式（严禁）】
债务人XXX有限公司成立于
2007
年
6
月
1
日（这样拆分是错误的！）

【模板】
${template}

【换行符使用规则】
1. 每个大标题后：换行两次（即一个空行）
2. 每个段落后：换行两次  
3. 每个列表项：换行一次
4. 绝对不要把多行内容写在同一行

【列表格式规则】
1. ❌ 禁止使用字母标记：不要输出 "o出售资产"、"o注入资产" 这样的格式
2. ✅ 正确格式：直接输出内容，如 "出售资产清单："、"注入资产清单："
3. ✅ 如果是列表项，使用数字编号（1. 2. 3.）或不使用任何标记

【数据来源】
${documentText}

${getDateHandlingRules(dates)}

【最终输出前的检查清单】
在输出之前，请确保：
1. ✅ 所有 XXX、XX、____ 占位符已替换
2. ✅ 所有段落保持完整，没有不必要的换行
3. ✅ 标题和段落之间有空行
4. ❌ 没有 "o出售"、"o注入"、"o增发" 这样的字母标记
5. ❌ 没有 "•"、"○"、"●" 等符号标记
6. ✅ 列表项使用数字编号或无标记格式

【立即开始输出】
记住：输出必须是多行文本，大量使用换行符。从第一行就开始换行：

【第二步：具体的输出格式示例】

❌ 错误的输出（全部挤在一起）：
"辣椒炒肉有限公司 重整计划草案 二〇二五年十一月二十八日 目录 释义..... 1 说明..... 7 前言..... 9 摘要..... 10 正文..... 12 释义 1. 本重整计划草案中，除非上下文另有规定，下列词语具有如下特定含义：债务人公司：指辣椒炒肉有限公司 预重整：指在人民法院裁定受理重整申请前..."

✅ 正确的输出（保持换行和段落，无字母标记）：
"辣椒炒肉有限公司
重整计划草案
二〇二五年十一月二十八日

目录
释义
说明
前言
摘要
正文

释义

1. 本重整计划草案中，除非上下文另有规定，下列词语具有如下特定含义：

债务人公司：指辣椒炒肉有限公司

预重整：指在人民法院裁定受理重整申请前...

2.资产重组细节：

出售资产清单：【待补充】（包括资产名称、估值）

注入资产清单：【待补充】（包括资产名称、估值、来源）

3.股权变动细节：

增发股份数量：【待补充】股

认购方：债权人A认购【待补充】股，债权人B认购【待补充】股

股权结构变化：重组前后股权对比表。"

❌ 错误的输出（有字母标记）：
"2.资产重组细节：

o出售资产清单：【待补充】

o注入资产清单：【待补充】

3.股权变动细节：

o增发股份数量：【待补充】股

o认购方：债权人A认购【待补充】股"

看到区别了吗？✅正确的输出有：
- 每个标题独立成行
- 段落之间有空行
- 列表项分行显示

【第三步：你必须做到】

1. ✅ 只替换占位符：
   XXX → 实际信息
   XXXX → 实际信息
   ____ → 实际信息

2. ✅ 保持所有换行：
   模板中的每一个换行符都必须保留
   不要把多行合并成一行

3. ✅ 保持段落分隔：
   段落之间的空行必须保留

4. ❌ 绝对不能：
   - 把多行文字合并成一行
   - 删除空行
   - 改变标题格式
   - 添加或删除任何内容（除了填充占位符）

${getDateHandlingRules(dates)}

${COMMON_FORMAT_RULES}

【第四步：输出格式要求】

🔴 重要规则：

1. ✅ 标题独立成行，标题后空一行
2. ✅ 段落保持完整（不要将句子拆开）
3. ❌ 不要过度换行（不要将日期拆成多行）
4. ❌ 不要添加页码
5. ❌ 不要使用任何特殊符号（*、#、-）

正确示例：
【示例开始】
公司名称

重整计划草案

二〇二五年十一月三十日

一、债务人基本情况

债务人XXX有限公司成立于2007年6月1日，注册资本为1000万元。

错误示例（禁止）：
债务人XXX有限公司成立于
2007
年
6
月
1
日
【示例结束】

核心：保持段落完整，不要过度拆分！
[空行]
段落内容第一段。
[空行]
（一）小节标题
[空行]  
段落内容第二段。
[空行]
（二）小节标题
[空行]
段落内容第三段。
【示例结束】

${getDateHandlingRules(dates)}

${COMMON_FORMAT_RULES}

【第五步：数据来源】
从以下文档中提取信息，用于填充模板中的XXX等占位符：

${documentText}

【第六步：立即开始输出】
现在请严格按照模板格式，逐行输出完整的预重整方案。记住：
- 标题单独成行
- 段落之间有空行
- 不要合并多行文字
- 保持模板的所有换行

开始输出：`;
        }
    },

    // 债权人会议报告功能已删除

    // 会议字段提取
    'meeting-fields': {
        system: '你是一位专业的信息提取专家，擅长从会议文档中提取结构化信息。',
        user: (documentText) => `请从以下文档内容中提取第一次债权人会议的关键字段信息，以JSON格式返回：
{
  "meetingTime": "会议时间",
  "meetingLocation": "会议地点", 
  "chairperson": "会议主持人",
  "attendees": ["参会人员列表"],
  "mainTopics": ["主要议题"],
  "votingResults": ["表决结果"],
  "nextMeetingDate": "下次会议时间",
  "importantDecisions": ["重要决议"]
}

请确保提取的信息准确完整，如果某些信息在文档中不存在，请标注为"未提及"。

文档内容：
${documentText}`
    }
};

/**
 * 获取指定类型的 prompt（异步）
 */
async function getPrompt(analysisType, documentText) {
    const dates = generateDateFormats();
    const promptConfig = PROMPTS[analysisType];
    
    if (!promptConfig) {
        return {
            system: '你是一位专业的企业分析师，擅长文档分析和信息提取。',
            user: `请分析以下文档内容，提供专业的分析报告：\n\n文档内容：\n${documentText}`
        };
    }
    
    // 支持异步和同步的user函数
    let userPrompt;
    if (typeof promptConfig.user === 'function') {
        userPrompt = await promptConfig.user(documentText, dates);
    } else {
        userPrompt = promptConfig.user;
    }
    
    return {
        system: promptConfig.system,
        user: userPrompt
    };
}

/**
 * 获取分析类型的超时配置
 */
function getTimeoutConfig(analysisType) {
    // 需要长时间生成的大文档/长报告类型
    const longFormTypes = [
        'pre-restructure-plan',
        'outside-agreement',
        'restructure-feasibility'
    ];
    
    // 中等长度报告类型
    const mediumFormTypes = [
        'enterprise-value',
        'risk-indicators',
        'value-risk'
    ];
    
    // 【API限制】DeepSeek API max_tokens 最大值为 8192
    // 策略：使用API允许的最大值，生成最详细的报告
    // 关键：已通过 Accept-Encoding: identity 禁用Gzip压缩，保证稳定性
    if (longFormTypes.includes(analysisType)) {
        return {
            timeout: 1200000,   // 20分钟（超长时间，确保生成完整）
            maxTokens: 8192,    // API最大限制（约5500-6500字）
            temperature: 0.3
        };
    } else if (mediumFormTypes.includes(analysisType)) {
        return {
            timeout: 900000,    // 15分钟
            maxTokens: 8192,    // API最大限制（约5500-6500字）
            temperature: 0.2
        };
    } else {
        return {
            timeout: 600000,    // 10分钟
            maxTokens: 8192,    // API最大限制（约5500-6500字）
            temperature: 0.1
        };
    }
}

/**
 * 【用户要求】不限制文档长度，智能截断（仅在极端情况下）
 * 
 * 新策略（无限制模式）：
 * - 默认限制：20,000字符（大幅提高）
 * - 实际上很少会触发截断
 * - 已通过禁用Gzip保证传输稳定性
 */
function truncateDocumentText(text, maxChars = 20000) {
    if (!text || text.length <= maxChars) {
        console.log(`✓ 文档长度正常: ${text.length}字符`);
        return text;
    }
    
    console.warn(`⚠️ 文档内容过大 (${text.length}字符)，截断到${maxChars}字符`);
    console.warn(`   建议：减少上传文档数量或大小，以获得更完整的分析结果`);
    
    // 智能截断：优先保留前面的内容（通常包含关键信息）
    let truncated = text.substring(0, maxChars);
    
    // 在最后一个完整段落处截断（避免截断到句子中间）
    const lastParagraph = truncated.lastIndexOf('\n\n');
    const lastSentence = Math.max(
        truncated.lastIndexOf('。'),
        truncated.lastIndexOf('！'),
        truncated.lastIndexOf('？'),
        truncated.lastIndexOf('.')
    );
    
    // 选择最佳截断点
    if (lastParagraph > maxChars * 0.8) {
        truncated = truncated.substring(0, lastParagraph);
    } else if (lastSentence > maxChars * 0.9) {
        truncated = truncated.substring(0, lastSentence + 1);
    }
    
    const warningMessage = '\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n' +
        '⚠️ 提示：文档内容过长，已自动截断\n' +
        `原始长度：${text.length}字符\n` +
        `截断后长度：${truncated.length}字符\n` +
        `截断比例：${((truncated.length / text.length) * 100).toFixed(1)}%\n\n` +
        '💡 建议：\n' +
        '1. 减少上传文档数量（推荐2-3个核心文档）\n' +
        '2. 上传更小的文件（每个 < 5MB）\n' +
        '3. 优先上传Excel/Word格式（避免大PDF）\n' +
        '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━';
    
    return truncated + warningMessage;
}

module.exports = {
    getPrompt,
    getTimeoutConfig,
    generateDateFormats,
    truncateDocumentText
};

